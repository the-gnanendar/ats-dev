{% load basefilters %}
{% load i18n %}{% load static %} {% load recruitmentfilters horillafilters %}

{% if messages %}
<div class="oh-wrapper">
  {% for message in messages %}
  <div class="oh-alert-container">
    <div class="oh-alert oh-alert--animated {{message.tags}}">
      {{ message }}
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<style>
  .note-modal-backdrop {
      z-index: 998 !important;
  }

  .tooltip {
      position: relative;
      display: inline-block;
  }

  .tooltip .tooltiptext {
      visibility: hidden;
      width: auto;
      max-width: auto;
      background-color: green;
      color: white;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 5%;
      left: 50%;
      transform: translateX(5%);
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
      overflow: hidden;
      font-size: 15px;
  }

  .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
  }
</style>

{% include 'filter_tags.html' %}

{% if candidate_applications %}
  <!-- start of select all -->
  <div class="oh-checkpoint-badge text-success mb-2" id="selectAllInstances" style="cursor: pointer;">
    {% trans "Select All Applications" %}
  </div>
  <div class="oh-checkpoint-badge text-secondary mb-2" id="unselectAllInstances" style="cursor: pointer;display: none;">
    {% trans "Unselect All Applications" %}
  </div>
  <div class="oh-checkpoint-badge text-info mb-2" id="exportApplications" style="cursor: pointer;display: none;">
      {% trans "Export Applications" %}
  </div>
  <div class="oh-checkpoint-badge text-danger mb-2" id="selectedApplication" style="display: none">
  </div>
  <!-- start of select all -->
  <!-- start of column toggle button -->
  <div class="oh-table_sticky--wrapper">
    <div class="oh-sticky-dropdown--header">
      <div class="oh-dropdown" x-data="{open: false}">
        <button class="oh-sticky-dropdown_btn " @click="open = !open"><ion-icon name="ellipsis-vertical-sharp"
          role="img" class="md hydrated" aria-label="ellipsis vertical sharp"></ion-icon></button>
        <div class="oh-dropdown__menu oh-sticky-table_dropdown" x-show="open" @click.outside="open = false">
        <ul class="oh-dropdown__items" id="ApplicationCells">
        </ul>
        </div>
      </div>
    </div>
  </div>
  <!-- end of column toggle button -->
  <div id="application-toggle-table" data-table-name="application_toggle_tab">
    <!-- start of sticky table -->
    <div class="oh-sticky-table">
      <div class="oh-sticky-table__table oh-table--sortable">
        <div class="oh-sticky-table__thead">
          <div class="oh-sticky-table__tr">
            <div class="oh-sticky-table__th" style="width:10px;">
              <div class="centered-div" align="center">
                <input type="checkbox" class="oh-input oh-input__checkbox group-select"
                onchange="$(this).closest('.oh-sticky-table').find('.application-checkbox').prop('checked',$(this).is(':checked')).change();"
                 title="Select All"  />
              </div>
            </div>
            <div class="oh-sticky-table__th {% if request.sort_option.order == '-name' %}arrow-up {% elif request.sort_option.order == 'name' %}arrow-down {% else %} arrow-up-down {% endif %}"  hx-target='#section' hx-get="{% url 'candidate-application-search' %}?{{pd}}&orderby=name&view=list">{% trans "Applications" %}</div>
            <div data-cell-index="1" data-cell-title='{% trans "Email" %}' class="oh-sticky-table__th">{% trans "Email" %}</div>
            <div data-cell-index="2" data-cell-title='{% trans "Phone" %}' class="oh-sticky-table__th">{% trans "Phone" %}</div>
            <div data-cell-index="3" data-cell-title='{% trans "Recruitment" %}' class="oh-sticky-table__th">{% trans "Recruitment" %}</div>
            <div data-cell-index="4" data-cell-title='{% trans "Job Position" %}' class="oh-sticky-table__th">{% trans "Job Position" %}</div>
            <div data-cell-index="5" data-cell-title='{% trans "Stage" %}' class="oh-sticky-table__th">{% trans "Stage" %}</div>
            <div data-cell-index="6" data-cell-title='{% trans "Status" %}' class="oh-sticky-table__th">{% trans "Status" %}</div>
            <div data-cell-index="7" data-cell-title='{% trans "Actions" %}' class="oh-sticky-table__th">{% trans "Actions" %}</div>
          </div>
        </div>
        <div class="oh-sticky-table__tbody">
          {% for app in candidate_applications %}
          <div class="oh-sticky-table__tr" draggable="false">
            <div class="oh-sticky-table__td">
              <div class="centered-div" align="center">
                <input type="checkbox" class="oh-input oh-input__checkbox application-checkbox" 
                       onchange="$(this).closest('.oh-sticky-table').find('.group-select').prop('checked',false);"
                       value="{{ app.id }}" />
              </div>
            </div>
            <div class="oh-sticky-table__td candidate-application {% if app.hired %}hired-cand{% endif %}">
              <div class="d-flex">
                <a href="{% url 'candidate-view-individual' app.id %}" style="color: inherit;text-decoration: none;"
                class="oh-profile oh-profile--md">
                  <div class="oh-profile__avatar mr-1">
                    <img src="{{ app.get_avatar }}"
                    class="oh-profile__image"
                    alt="{{ app.name }}" />
                  </div>
                  <span class="oh-profile__name oh-text--dark">{{ app.name }}</span>
                </a>
                {% if app.email in existing_emails %}
                  <span class="tooltip">
                    <span class="material-symbols-outlined ms-2" style="flex-direction: row-reverse;color:green;">
                        how_to_reg
                      </span>
                      <span class="tooltiptext fw-bold">
                        {% trans "Converted to employee." %}
                      </span>
                  </span>
                {% endif %}
              </div>
            </div>

            <a data-cell-index="1" href="{% url 'candidate-view-individual' app.id %}" style="color: inherit;text-decoration: none;" class="oh-sticky-table__td ">{{app.email}}</a>
            <a data-cell-index="2" href="{% url 'candidate-view-individual' app.id %}" style="color: inherit;text-decoration: none;" class="oh-sticky-table__td">{{app.mobile}}</a>
            <a data-cell-index="3" href="{% url 'candidate-view-individual' app.id %}" style="color: inherit;text-decoration: none;" class="oh-sticky-table__td">
              {% if app.recruitment_id %}
                {{app.recruitment_id.title}}
              {% else %}
                -
              {% endif %}
            </a>
            <a data-cell-index="4" href="{% url 'candidate-view-individual' app.id %}" style="color: inherit;text-decoration: none;"
              class="oh-sticky-table__td">
              {% if app.job_position_id %}
                {{app.job_position_id.job_position}}
              {% else %}
                -
              {% endif %}
            </a>
            <a data-cell-index="5" href="{% url 'candidate-view-individual' app.id %}" style="color: inherit;text-decoration: none;"
              class="oh-sticky-table__td">
              {% if app.stage_id %}
                <span class="oh-badge oh-badge--{{ app.stage_id.stage_type }}">{{app.stage_id.stage}}</span>
              {% else %}
                -
              {% endif %}
            </a>
            <div data-cell-index="6" class="oh-sticky-table__td">
              {% if app.hired %}
                <span class="oh-badge oh-badge--success">{% trans "Hired" %}</span>
              {% elif app.canceled %}
                <span class="oh-badge oh-badge--danger">{% trans "Canceled" %}</span>
              {% elif app.converted %}
                <span class="oh-badge oh-badge--warning">{% trans "Converted" %}</span>
              {% else %}
                <span class="oh-badge oh-badge--secondary">{% trans "Active" %}</span>
              {% endif %}
            </div>
            <div data-cell-index="7" class="oh-sticky-table__td">
              <div class="oh-btn-group">
                <a href="{% url 'candidate-view-individual' app.id %}" 
                   class="oh-btn oh-btn--sm oh-btn--light" 
                   title="{% trans 'View Details' %}">
                  <ion-icon name="eye-outline"></ion-icon>
                </a>
                <a href="{% url 'candidate-application-update' app.id %}" 
                   class="oh-btn oh-btn--sm oh-btn--info" 
                   title="{% trans 'Edit' %}">
                  <ion-icon name="create-outline"></ion-icon>
                </a>
                {% if perms.recruitment.delete_candidateapplication %}
                <button type="button" 
                        class="oh-btn oh-btn--sm oh-btn--danger" 
                        title="{% trans 'Delete' %}"
                        onclick="showDeleteModal({{ app.id }})">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% else %}
  <div class="oh-wrapper">
    <div class="oh-empty-state">
      <div class="oh-empty-state__content">
        <div class="oh-empty-state__icon">
          <ion-icon name="people-outline"></ion-icon>
        </div>
        <h3 class="oh-empty-state__title">{% trans "No Candidate Applications Found" %}</h3>
        <p class="oh-empty-state__description">
          {% trans "No candidate applications match your current filters. Try adjusting your search criteria or create a new application." %}
        </p>
        {% if perms.recruitment.add_candidateapplication %}
        <div class="oh-empty-state__actions">
          <a href="{% url 'candidate-application-create' %}" class="oh-btn oh-btn--primary">
            <ion-icon name="add-sharp" class="mr-1"></ion-icon>
            {% trans "Create Application" %}
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}

<script>
  $(document).ready(function() {
    // Initialize sticky table functionality
    if (typeof initializeStickyTable === 'function') {
      initializeStickyTable('#application-toggle-table');
    }
  });
</script> 