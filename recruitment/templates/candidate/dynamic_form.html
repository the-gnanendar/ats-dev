{% extends 'index.html' %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="oh-card">
    <div class="oh-card__header">
        <h4 class="oh-card__title">{{ form_title }}</h4>
        <div class="oh-card__actions">
            <a href="{% url 'candidate-view-individual' candidate.id %}" class="oh-btn oh-btn--secondary">
                <ion-icon name="arrow-back-outline"></ion-icon>
                {% trans "Back to Profile" %}
            </a>
        </div>
    </div>
    
    <div class="oh-card__body">
        <form method="post" id="dynamic-form">
            {% csrf_token %}
            {{ formset.management_form }}
            
            <div id="formset-container">
                {% for form in formset %}
                <div class="formset-form mb-4 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            {% if form.instance.pk %}
                                {% if form_type == 'work_experience' %}
                                    {{ form.instance.job_title }} at {{ form.instance.company_name }}
                                {% elif form_type == 'education' %}
                                    {{ form.instance.degree_name }} from {{ form.instance.institution_name }}
                                {% elif form_type == 'certifications' %}
                                    {{ form.instance.certification_name }}
                                {% elif form_type == 'skills' %}
                                    {{ form.instance.skill_name }}
                                {% elif form_type == 'work_projects' %}
                                    {{ form.instance.project_name }}
                                {% endif %}
                            {% else %}
                                {% trans "New Entry" %}
                            {% endif %}
                        </h6>
                        <div class="form-actions">
                            {% if form.instance.pk %}
                                <button type="button" class="oh-btn oh-btn--danger oh-btn--sm delete-form" 
                                        data-form-id="{{ form.instance.pk }}">
                                    <ion-icon name="trash-outline"></ion-icon>
                                    {% trans "Delete" %}
                                </button>
                            {% else %}
                                <button type="button" class="oh-btn oh-btn--danger oh-btn--sm remove-form">
                                    <ion-icon name="close-outline"></ion-icon>
                                    {% trans "Remove" %}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        {% for field in form %}
                        <div class="col-md-6 mb-3">
                            <label for="{{ field.id_for_label }}" class="oh-label">
                                {{ field.label }}
                                {% if field.field.required %}
                                    <span class="text-danger">*</span>
                                {% endif %}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small">
                                    {% for error in field.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if field.help_text %}
                                <div class="text-muted small">{{ field.help_text }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if form_type == 'work_experience' and form.instance.pk %}
                    <div class="mt-3">
                        <a href="{% url 'candidate-work-projects-update' form.instance.pk %}" 
                           class="oh-btn oh-btn--secondary oh-btn--sm">
                            <ion-icon name="folder-outline"></ion-icon>
                            {% trans "Manage Projects" %}
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-4">
                <button type="button" class="oh-btn oh-btn--secondary" id="add-form">
                    <ion-icon name="add-outline"></ion-icon>
                    {% trans "Add Another" %}
                </button>
                <button type="submit" class="oh-btn oh-btn--primary">
                    <ion-icon name="save-outline"></ion-icon>
                    {% trans "Save Changes" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addFormBtn = document.getElementById('add-form');
    const managementForm = document.querySelector('#dynamic-form input[name="form-TOTAL_FORMS"]');
    const maxForms = document.querySelector('#dynamic-form input[name="form-MAX_NUM_FORMS"]');
    
    let formIndex = {{ formset|length }};
    
    // Add new form
    addFormBtn.addEventListener('click', function() {
        const newForm = document.querySelector('.formset-form').cloneNode(true);
        const formIndex = document.querySelectorAll('.formset-form').length;
        
        // Update form index
        newForm.dataset.formIndex = formIndex;
        newForm.querySelector('h6').textContent = '{% trans "New Entry" %}';
        
        // Clear form fields
        newForm.querySelectorAll('input, textarea, select').forEach(field => {
            if (field.type !== 'hidden') {
                field.value = '';
            }
            // Update field names and IDs
            field.name = field.name.replace(/form-\d+/, 'form-' + formIndex);
            field.id = field.id.replace(/form-\d+/, 'form-' + formIndex);
        });
        
        // Update labels
        newForm.querySelectorAll('label').forEach(label => {
            label.setAttribute('for', label.getAttribute('for').replace(/form-\d+/, 'form-' + formIndex));
        });
        
        // Show remove button for new forms
        const actionsDiv = newForm.querySelector('.form-actions');
        actionsDiv.innerHTML = '<button type="button" class="oh-btn oh-btn--danger oh-btn--sm remove-form">' +
            '<ion-icon name="close-outline"></ion-icon>' +
            '{% trans "Remove" %}' +
            '</button>';
        
        formsetContainer.appendChild(newForm);
        managementForm.value = formIndex + 1;
        
        // Add remove functionality
        newForm.querySelector('.remove-form').addEventListener('click', function() {
            newForm.remove();
            managementForm.value = document.querySelectorAll('.formset-form').length;
        });
    });
    
    // Remove form (for new forms)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-form')) {
            const formDiv = e.target.closest('.formset-form');
            formDiv.remove();
            managementForm.value = document.querySelectorAll('.formset-form').length;
        }
    });
    
    // Delete existing form
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-form')) {
            const formId = e.target.closest('.delete-form').dataset.formId;
            if (confirm('{% trans "Are you sure you want to delete this entry?" %}')) {
                // Add hidden field to mark for deletion
                const formDiv = e.target.closest('.formset-form');
                const deleteField = document.createElement('input');
                deleteField.type = 'hidden';
                deleteField.name = 'form-' + formDiv.dataset.formIndex + '-DELETE';
                deleteField.value = 'on';
                formDiv.appendChild(deleteField);
                
                // Hide the form
                formDiv.style.display = 'none';
            }
        }
    });
    
    // Handle current job/education checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.name.includes('is_current') && e.target.checked) {
            // Uncheck other is_current checkboxes
            document.querySelectorAll('input[name*="is_current"]').forEach(checkbox => {
                if (checkbox !== e.target) {
                    checkbox.checked = false;
                }
            });
        }
    });
});
</script>

<style>
.formset-form {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.formset-form:hover {
    background-color: #e9ecef;
}

.form-actions {
    display: flex;
    gap: 0.5rem;
}

.oh-label {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.oh-input, .oh-select, .oh-textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

.oh-textarea {
    resize: vertical;
    min-height: 80px;
}
</style>
{% endblock %} 