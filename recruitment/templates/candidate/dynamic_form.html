{% extends 'index.html' %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="oh-card">
    <div class="oh-card__header">
        <h4 class="oh-card__title">{{ form_title }}</h4>
        <div class="oh-card__actions">
            <a href="{% url 'candidate-view-individual' candidate.id %}" class="oh-btn oh-btn--secondary">
                <ion-icon name="arrow-back-outline"></ion-icon>
                {% trans "Back to Profile" %}
            </a>
        </div>
    </div>
    
    <div class="oh-card__body">
        <form method="post" id="dynamic-form">
            {% csrf_token %}
            {{ formset.management_form }}
            
            <div id="formset-container">
                {% for form in formset %}
                <div class="formset-form mb-4 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            {% if form.instance.pk %}
                                {% if form_type == 'work_experience' %}
                                    {{ form.instance.job_title }} at {{ form.instance.company_name }}
                                {% elif form_type == 'work_experience_with_projects' %}
                                    {{ form.instance.job_title }} at {{ form.instance.company_name }}
                                {% elif form_type == 'education' %}
                                    {{ form.instance.degree_name }} from {{ form.instance.institution_name }}
                                {% elif form_type == 'certifications' %}
                                    {{ form.instance.certification_name }}
                                {% elif form_type == 'skills' %}
                                    {{ form.instance.skill_name }}
                                {% elif form_type == 'work_projects' %}
                                    {{ form.instance.project_name }}
                                {% endif %}
                            {% else %}
                                {% trans "New Entry" %}
                            {% endif %}
                        </h6>
                        <div class="form-actions">
                            {% if form.instance.pk %}
                                <button type="button" class="oh-btn oh-btn--danger oh-btn--sm delete-form" 
                                        data-form-id="{{ form.instance.pk }}">
                                    <ion-icon name="trash-outline"></ion-icon>
                                    {% trans "Delete" %}
                                </button>
                            {% else %}
                                <button type="button" class="oh-btn oh-btn--danger oh-btn--sm remove-form">
                                    <ion-icon name="close-outline"></ion-icon>
                                    {% trans "Remove" %}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        {% for field in form %}
                        <div class="col-md-6 mb-3">
                            <label for="{{ field.id_for_label }}" class="oh-label">
                                {{ field.label }}
                                {% if field.field.required %}
                                    <span class="text-danger">*</span>
                                {% endif %}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small">
                                    {% for error in field.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if field.help_text %}
                                <div class="text-muted small">{{ field.help_text }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if form_type == 'work_experience_with_projects' %}
                    <div class="projects-section mt-4">
                        <h6 class="oh-label mb-3">{% trans "Projects" %}</h6>
                        <div class="projects-container" data-experience-index="{{ forloop.counter0 }}">
                            {% if form.instance.pk and form.instance.projects.all %}
                                {% for project in form.instance.projects.all %}
                                <div class="project-form mb-3 p-3 border rounded" data-project-index="{{ forloop.counter0 }}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">{{ project.project_name|default:"New Project" }}</h6>
                                        <button type="button" class="oh-btn oh-btn--danger oh-btn--sm remove-project">
                                            <ion-icon name="close-outline"></ion-icon>
                                            {% trans "Remove" %}
                                        </button>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="oh-label">{% trans "Project Name" %}</label>
                                            <input type="text" name="project-{{ forloop.parentloop.counter0 }}-project_name-{{ forloop.counter0 }}" 
                                                   value="{{ project.project_name }}" class="oh-input w-100">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="oh-label">{% trans "Role" %}</label>
                                            <input type="text" name="project-{{ forloop.parentloop.counter0 }}-role-{{ forloop.counter0 }}" 
                                                   value="{{ project.role }}" class="oh-input w-100">
                                        </div>
                                        <div class="col-12 mb-2">
                                            <label class="oh-label">{% trans "Project Description" %}</label>
                                            <textarea name="project-{{ forloop.parentloop.counter0 }}-project_description-{{ forloop.counter0 }}" 
                                                      class="oh-textarea w-100" rows="3">{{ project.project_description }}</textarea>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="oh-label">{% trans "Technologies Used" %}</label>
                                            <input type="text" name="project-{{ forloop.parentloop.counter0 }}-technologies_used-{{ forloop.counter0 }}" 
                                                   value="{{ project.technologies_used }}" class="oh-input w-100">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="oh-label">{% trans "Project URL" %}</label>
                                            <input type="url" name="project-{{ forloop.parentloop.counter0 }}-project_url-{{ forloop.counter0 }}" 
                                                   value="{{ project.project_url }}" class="oh-input w-100">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="oh-label">{% trans "Start Date" %}</label>
                                            <input type="date" name="project-{{ forloop.parentloop.counter0 }}-start_date-{{ forloop.counter0 }}" 
                                                   value="{{ project.start_date|date:'Y-m-d' }}" class="oh-input w-100">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="oh-label">{% trans "End Date" %}</label>
                                            <input type="date" name="project-{{ forloop.parentloop.counter0 }}-end_date-{{ forloop.counter0 }}" 
                                                   value="{{ project.end_date|date:'Y-m-d' }}" class="oh-input w-100">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="oh-label">
                                                <input type="checkbox" name="project-{{ forloop.parentloop.counter0 }}-is_current-{{ forloop.counter0 }}" 
                                                       {% if project.is_current %}checked{% endif %} class="oh-checkbox">
                                                {% trans "Currently Working" %}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="oh-btn oh-btn--secondary oh-btn--sm add-project" 
                                data-experience-index="{{ forloop.counter0 }}">
                            <ion-icon name="add-outline"></ion-icon>
                            {% trans "Add Project" %}
                        </button>
                    </div>
                    {% endif %}
                    
                    {% if form_type == 'work_experience' and form.instance.pk %}
                    <div class="mt-3">
                        <a href="{% url 'candidate-work-projects-update' form.instance.pk %}" 
                           class="oh-btn oh-btn--secondary oh-btn--sm">
                            <ion-icon name="folder-outline"></ion-icon>
                            {% trans "Manage Projects" %}
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-4">
                <button type="button" class="oh-btn oh-btn--secondary" id="add-form">
                    <ion-icon name="add-outline"></ion-icon>
                    {% trans "Add Another" %}
                </button>
                <button type="submit" class="oh-btn oh-btn--primary">
                    <ion-icon name="save-outline"></ion-icon>
                    {% trans "Save Changes" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addFormBtn = document.getElementById('add-form');
    const managementForm = document.querySelector('#dynamic-form input[name="form-TOTAL_FORMS"]');
    const maxForms = document.querySelector('#dynamic-form input[name="form-MAX_NUM_FORMS"]');
    
    let formIndex = {{ formset|length }};
    
    // Add new form
    addFormBtn.addEventListener('click', function() {
        const newForm = document.querySelector('.formset-form').cloneNode(true);
        const formIndex = document.querySelectorAll('.formset-form').length;
        
        // Update form index
        newForm.dataset.formIndex = formIndex;
        newForm.querySelector('h6').textContent = '{% trans "New Entry" %}';
        
        // Clear form fields
        newForm.querySelectorAll('input, textarea, select').forEach(field => {
            if (field.type !== 'hidden') {
                field.value = '';
            }
            // Update field names and IDs
            field.name = field.name.replace(/form-\d+/, 'form-' + formIndex);
            field.id = field.id.replace(/form-\d+/, 'form-' + formIndex);
        });
        
        // Update labels
        newForm.querySelectorAll('label').forEach(label => {
            label.setAttribute('for', label.getAttribute('for').replace(/form-\d+/, 'form-' + formIndex));
        });
        
        // Show remove button for new forms
        const actionsDiv = newForm.querySelector('.form-actions');
        actionsDiv.innerHTML = '<button type="button" class="oh-btn oh-btn--danger oh-btn--sm remove-form">' +
            '<ion-icon name="close-outline"></ion-icon>' +
            '{% trans "Remove" %}' +
            '</button>';
        
        formsetContainer.appendChild(newForm);
        managementForm.value = formIndex + 1;
        
        // Add remove functionality
        newForm.querySelector('.remove-form').addEventListener('click', function() {
            newForm.remove();
            managementForm.value = document.querySelectorAll('.formset-form').length;
        });
    });
    
    // Remove form (for new forms)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-form')) {
            const formDiv = e.target.closest('.formset-form');
            formDiv.remove();
            managementForm.value = document.querySelectorAll('.formset-form').length;
        }
    });
    
    // Delete existing form
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-form')) {
            const formId = e.target.closest('.delete-form').dataset.formId;
            if (confirm('{% trans "Are you sure you want to delete this entry?" %}')) {
                // Add hidden field to mark for deletion
                const formDiv = e.target.closest('.formset-form');
                const deleteField = document.createElement('input');
                deleteField.type = 'hidden';
                deleteField.name = 'form-' + formDiv.dataset.formIndex + '-DELETE';
                deleteField.value = 'on';
                formDiv.appendChild(deleteField);
                
                // Hide the form
                formDiv.style.display = 'none';
            }
        }
    });
    
    // Handle current job/education checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.name.includes('is_current') && e.target.checked) {
            // Uncheck other is_current checkboxes
            document.querySelectorAll('input[name*="is_current"]').forEach(checkbox => {
                if (checkbox !== e.target) {
                    checkbox.checked = false;
                }
            });
        }
    });
    
    // Add project functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.add-project')) {
            const experienceIndex = e.target.closest('.add-project').dataset.experienceIndex;
            const projectsContainer = e.target.closest('.projects-section').querySelector('.projects-container');
            const projectIndex = projectsContainer.querySelectorAll('.project-form').length;
            
            const projectForm = 
                '<div class="project-form mb-3 p-3 border rounded" data-project-index="' + projectIndex + '">' +
                    '<div class="d-flex justify-content-between align-items-center mb-2">' +
                        '<h6 class="mb-0">{% trans "New Project" %}</h6>' +
                        '<button type="button" class="oh-btn oh-btn--danger oh-btn--sm remove-project">' +
                            '<ion-icon name="close-outline"></ion-icon>' +
                            '{% trans "Remove" %}' +
                        '</button>' +
                    '</div>' +
                    '<div class="row">' +
                        '<div class="col-md-6 mb-2">' +
                            '<label class="oh-label">{% trans "Project Name" %}</label>' +
                            '<input type="text" name="project-' + experienceIndex + '-project_name-' + projectIndex + '" class="oh-input w-100">' +
                        '</div>' +
                        '<div class="col-md-6 mb-2">' +
                            '<label class="oh-label">{% trans "Role" %}</label>' +
                            '<input type="text" name="project-' + experienceIndex + '-role-' + projectIndex + '" class="oh-input w-100">' +
                        '</div>' +
                        '<div class="col-12 mb-2">' +
                            '<label class="oh-label">{% trans "Project Description" %}</label>' +
                            '<textarea name="project-' + experienceIndex + '-project_description-' + projectIndex + '" class="oh-textarea w-100" rows="3"></textarea>' +
                        '</div>' +
                        '<div class="col-md-6 mb-2">' +
                            '<label class="oh-label">{% trans "Technologies Used" %}</label>' +
                            '<input type="text" name="project-' + experienceIndex + '-technologies_used-' + projectIndex + '" class="oh-input w-100">' +
                        '</div>' +
                        '<div class="col-md-6 mb-2">' +
                            '<label class="oh-label">{% trans "Project URL" %}</label>' +
                            '<input type="url" name="project-' + experienceIndex + '-project_url-' + projectIndex + '" class="oh-input w-100">' +
                        '</div>' +
                        '<div class="col-md-4 mb-2">' +
                            '<label class="oh-label">{% trans "Start Date" %}</label>' +
                            '<input type="date" name="project-' + experienceIndex + '-start_date-' + projectIndex + '" class="oh-input w-100">' +
                        '</div>' +
                        '<div class="col-md-4 mb-2">' +
                            '<label class="oh-label">{% trans "End Date" %}</label>' +
                            '<input type="date" name="project-' + experienceIndex + '-end_date-' + projectIndex + '" class="oh-input w-100">' +
                        '</div>' +
                        '<div class="col-md-4 mb-2">' +
                            '<label class="oh-label">' +
                                '<input type="checkbox" name="project-' + experienceIndex + '-is_current-' + projectIndex + '" class="oh-checkbox">' +
                                '{% trans "Currently Working" %}' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            projectsContainer.insertAdjacentHTML('beforeend', projectForm);
        }
        
        // Remove project
        if (e.target.closest('.remove-project')) {
            const projectForm = e.target.closest('.project-form');
            projectForm.remove();
        }
    });
});
</script>

<style>
.formset-form {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.formset-form:hover {
    background-color: #e9ecef;
}

.project-form {
    background-color: #fff;
    border: 1px solid #dee2e6;
}

.project-form:hover {
    background-color: #f8f9fa;
}

.form-actions {
    display: flex;
    gap: 0.5rem;
}

.oh-label {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.oh-input, .oh-select, .oh-textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

.oh-textarea {
    resize: vertical;
    min-height: 80px;
}

.projects-section {
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
}
</style>
{% endblock %} 